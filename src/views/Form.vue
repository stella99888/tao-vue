<!-- formè¡¨å•ç»„ä»¶ çˆ·çˆ·ç»„ä»¶ 2024.05.25 -->
<template>
  <div class="form">
    <!-- æ¯ä¸ªå­™ç»„ä»¶éƒ½ä¼šæŠ›å‡ºçš„äº‹ä»¶ï¼Œé¡¶å±‚ä½¿ç”¨evå»æ¥å—æ‰€æœ‰äº‹ä»¶ -->
    <my-form :compArr="compArr" :form="form" :rules="rules" @ev="ev">
      <i slot="age&prefix" class="el-input__icon el-icon-platform-eleme"></i>
      <i slot="age&suffix" class="el-input__icon el-icon-eleme"></i>
      <i slot="address&prefix" class="el-input__icon el-icon-user-solid"></i>
      <i slot="address&suffix" class="el-input__icon el-icon-user-solid"></i>
      <i slot="food&prefix" class="el-input__icon el-icon-user-solid"></i>
    </my-form>
  </div>
</template>

<script>
import MyForm from "@/views/components/myForm";
import { getOptions, getOptionsCity, getOptionsAndDeepOptions } from '@/auth/api'
export default {
  name: "Form",
  components: { MyForm },
  data() {
    return {
      // ç°åœ¨çš„æ–¹å¼å«JSONé…ç½®åŒ–
      // ä¼ é€’ç»™el-formç”¨ï¼Œé€šè¿‡v-bind
      form: {},
      // é€šè¿‡æ•°æ®å»ç¡®å®šæ¸²æŸ“å“ªäº›è¡¨å•
      compArr: [
        {
          id: 1,
          isShow: true,
          name: 'å¹´é¾„',
          type: 'MyInput',
          span: 8,
          attr: {
            prop: 'age',
            placeholder: 'è¯·è¾“å…¥',
          },
        },
        {
          id: 2,
          isShow: true,
          name: 'æ—¥æœŸé€‰æ‹©æ¡†',
          type: 'MyDataPicker',
          span: 16,
          attr: {
            prop: 'data',
            vModel: "dataVal",
            type: "date",
            placeholder: "é€‰æ‹©æ—¥æœŸ",
          },
        },
        {
          id: 4,
          isShow: true,
          name: 'èµå¿ƒæ‚¦ç›®',
          type: 'MySelect',
          span: 18,
          attr: {
            prop: 'anima',
            placeholder: 'è¯·é€‰æ‹©',
          },
          optionArr: {
            back: {
              // ä¼ é€’ç»™å­ç»„ä»¶è¿›è¡Œè¯·æ±‚æ•°æ®
              // api: 'http://localhost:9999/getOptions',
              // æ–¹æ³•ä¼ é€’æ ‡å‡†çš„å†™æ³•,è¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥ä¼ objï¼Œarrï¼Œè§„åˆ™è‡ªå·±å®šâ¤
              api: getOptions,
              // è€ƒè™‘åˆ°åç«¯è¯·æ±‚å›æ¥çš„æ•°æ®ï¼Œvalueå’Œlabelå€¼ä¸æ˜¯è¿™ä¸€å¥—ï¼Œè¿™é‡Œæä¾›å¯è®¾ç½®çš„
              value: 'va',
              label: 'la',
            },
            // joiner: '-'
          },
        },
        {
          id: 3,
          isShow: true,
          name: 'åƒç‚¹ä»€ä¹ˆ',
          type: 'MySelect',
          span: 6,
          attr: {
            prop: 'food',
            placeholder: 'è¯·é€‰æ‹©',
          },
          optionArr: {
            font: [
              {
                value: 'milk',
                label: 'æ—ºä»”ç‰›å¥¶'
              }, {
                value: 'watermelon',
                label: 'èŠ‹åœ†è¥¿ç“œå†°ç²‰'
              }
            ]
          },
        },
        {
          id: 5,
          isShow: true,
          name: 'ä¿®ä»™ä¸–ç•Œ',
          type: 'MySelect',
          span: 8,
          attr: {
            prop: 'sea',
            placeholder: 'è¯·é€‰æ‹©',
          },
          optionArr: {
            font: [
              {
                value: '1',
                label: 'æ–—ç½—å¤§ä½¬'
              }, {
                value: '1-1',
                label: 'å¾¡å‰‘é£å‡'
              }
            ],
            // joiner: '()'
          },
        },
        {
          id: 7,
          isShow: true,
          name: 'åŸå¸‚',
          type: 'MySelect',
          span: 12,
          attr: {
            prop: 'city',
            placeholder: 'è¯·é€‰æ‹©',
          },
          optionArr: {
            back: {
              // ä¼ é€’ç»™å­ç»„ä»¶è¿›è¡Œè¯·æ±‚æ•°æ®
              // api: 'http://localhost:9999/getOptions',
              // æ–¹æ³•ä¼ é€’æ ‡å‡†çš„å†™æ³•,è¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥ä¼ objï¼Œarrï¼Œè§„åˆ™è‡ªå·±å®šâ¤
              api: getOptionsCity,
              // è€ƒè™‘åˆ°åç«¯è¯·æ±‚å›æ¥çš„æ•°æ®ï¼Œvalueå’Œlabelå€¼ä¸æ˜¯è¿™ä¸€å¥—ï¼Œè¿™é‡Œæä¾›å¯è®¾ç½®çš„
              value: 'va',
              label: 'la',
            },
            // å¯ä»¥å•ç‹¬æ‹å‡ºæ¥æ–¹æ³•åŠ ä¸åŒåˆ†éš”ç¬¦
            cbJoiner: this.cbJoiner,
            // joiner: 'and'
          },
        },
        {
          id: 8,
          isShow: true,
          name: 'åŒºå¿',
          type: 'MySelect',
          span: 12,
          attr: {
            prop: 'qu',
            placeholder: 'è¯·é€‰æ‹©',
          },
          optionArr: {
            back: {
              // å¦‚æœæ˜¯çº§è”çš„æƒ…å†µä¸‹ï¼Œéœ€è¦Aè¾“å…¥æ¡†é€‰æ‹©æ•°æ®åï¼Œä¼ å‚ç»™Bè¾“å…¥æ¡†
              // Bè¾“å…¥æ¡†å†è°ƒç”¨æ¥å£
              ap: null,
              value: 'va',
              label: 'la',
            },
          },
        },
        {
          id: 9,
          isShow: true,
          name: 'å®¶åº­ä½å€',
          type: 'MyInput',
          span: 8,
          attr: {
            prop: 'address',
            placeholder: 'è¯·è¾“å…¥',
            // type: "textarea"
          },
        },
      ],
      rules: {
        age: [
          { required: true, message: 'è¯·è¾“å…¥æ´»åŠ¨åç§°', trigger: 'blur' },
          { min: 3, max: 5, message: 'é•¿åº¦åœ¨ 3 åˆ° 5 ä¸ªå­—ç¬¦', trigger: 'blur' }
        ],
      },
    }
  },
  methods: {
    cbJoiner(conf, val) {
      return val.map(item => {
        return {
          value: `111${item[conf.back?.value]}`,
          label: `ğŸ˜‚${item[conf.back?.label]}ğŸ˜‚`
        }
      })
    },
    // é€šè¿‡$listenerï¼Œçˆ·ç»„ä»¶æ¥æ”¶å­™ç»„ä»¶çš„å‚æ•°
    ev(val) {
      console.log('val', val);
      this.setBorder(val)
      this.controlCity(val)
      this.controlAdd(val)
    },
    // æ§åˆ¶ageï¼Œèšç„¦åˆ™è¾¹æ¡†å˜çº¢
    setBorder(val) {
      let dom = document.querySelector('.el-input__inner')
      let border = dom.style.border
      if (val.eventName === "focus" && val.propName === 'age') border = '1px solid red'
      if (val.eventName === "blur" && val.propName === 'age') border = 'none'
    },
    // æ§åˆ¶cityï¼Œçº§è”é€‰æ‹©
    controlCity(val) {
      if (val.propName === 'city') {
        // è¿™é‡Œä½¿ç”¨$set,æ·»åŠ å±æ€§ï¼Œæ‰èƒ½æ˜¯åŒå‘ç»‘å®šçš„
        this.$set(this.form, 'qu', '')
        this.compArr.find(item => {
          if (item.attr.prop === 'qu') {
            /**
             * é«˜é˜¶å‡½æ•°ï¼Œä¼ é€’é¢å¤–å‚æ•°çš„ç”¨æ³•
             * let fnn = (extraParam) => (...args) => getOptionsAndDeepOptions.apply(this, [extraParam, ...args]);
             * Bè¾“å…¥æ¡†çš„æ¥å£ï¼Œéœ€è¦ä¼ å‚ï¼Œéœ€è¦åœ¨å­™ç»„ä»¶è°ƒç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦åŒ¿åå‡½æ•°è‡ªè°ƒç”¨çš„æ–¹å¼
             * è¿™ä¹Ÿæ˜¯é«˜é˜¶å‡½æ•°çš„è°ƒç”¨æ–¹æ³•
             */
            item.optionArr.back.ap = (
              function (params) {
                return function () {
                  return getOptionsAndDeepOptions(params)
                }
              }
            )({ cityVal: val.propValue })
          }
        });
      }
    },
    // æ§åˆ¶addressï¼Œä¸å…è®¸è¾“å…¥è¿å†™sb
    controlAdd(val) {
      if (val.propName === 'address') {
        if (val.propValue.includes('sb')) {
          this.$set(this.form, 'address', '')
        }
      }
    }
  },
  watch: {
    form: {
      handler(nval, oval) {
        // console.log(nval, oval);
      },
      deep: true,
      immediate: true
    },

  }
};
</script>
<style scoped lang="scss"></style>